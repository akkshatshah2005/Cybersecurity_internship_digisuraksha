from flask import Flask, request, redirect, render_template
import string, random

app = Flask(__name__)
url_map = {}

def generate_slug(length=6):
    characters = string.ascii_letters + string.digits
    return ''.join(random.choices(characters, k=length))

@app.route("/", methods=["GET", "POST"])
def index():
    message = ""
    short_url = None

    if request.method == "POST":
        long_url = request.form["long_url"]
        custom_slug = request.form["custom_slug"].strip()

        # Use custom slug if provided
        if custom_slug:
            if custom_slug in url_map:
                message = f"❌ Custom slug '{custom_slug}' is already taken!"
            else:
                url_map[custom_slug] = long_url
                short_url = request.host_url + custom_slug
                message = "✅ Custom short URL created!"
        else:
            slug = generate_slug()
            while slug in url_map:
                slug = generate_slug()
            url_map[slug] = long_url
            short_url = request.host_url + slug
            message = "✅ Random short URL created!"

    return render_template("index.html", short_url=short_url, message=message)

@app.route("/<slug>")
def redirect_to_long(slug):
    long_url = url_map.get(slug)
    if long_url:
        return redirect(long_url)
    return "⚠️ Link not found or expired.", 404

if __name__ == "__main__":
    app.run(debug=True)
